{"version":3,"file":"index.js","sources":["../src/annotations.ts","../src/github.ts","../src/inputs.ts","../src/index.ts"],"sourcesContent":["import { Annotation } from '@/annotation'\n\nexport type AnnotationsConclusion = 'success' | 'failure' | 'neutral'\n\nexport class Annotations extends Array<Annotation> {\n  public static fromJSON(json: string): Annotations {\n    return new Annotations(...JSON.parse(json))\n  }\n\n  public hasFailure(): boolean {\n    return this.some(annotation => annotation.level === 'failure')\n  }\n\n  public hasWarning(): boolean {\n    return this.some(annotation => annotation.level === 'warning')\n  }\n\n  public get failures(): Annotation[] {\n    return this.filter(annotation => annotation.level === 'failure')\n  }\n\n  public get warnings(): Annotation[] {\n    return this.filter(annotation => annotation.level === 'warning')\n  }\n\n  public get notices(): Annotation[] {\n    return this.filter(annotation => annotation.level === 'notice')\n  }\n\n  public get conclusion(): AnnotationsConclusion {\n    if (this.length === 0) return 'success'\n    if (this.hasFailure()) return 'failure'\n    if (this.hasWarning()) return 'neutral'\n    return 'success'\n  }\n}\n","import { Annotations } from '@/annotations'\nimport { Context } from '@actions/github/lib/context'\nimport { Octokit } from '@octokit/rest'\nimport github from '@actions/github'\n\nexport class Github {\n  private readonly client: github.GitHub\n  private readonly context: Context\n  private readonly owner: string\n  private readonly repo: string\n  private readonly sha: string\n  private check: Octokit.ChecksCreateResponse | null = null\n\n  public constructor(token: string) {\n    this.client = new github.GitHub({\n      auth: token,\n    })\n    this.context = github.context\n    this.owner = this.context.repo.owner\n    this.repo = this.context.repo.repo\n    this.sha = this.context.payload.pull_request?.head.sha ?? this.context.sha\n  }\n\n  private static githubAnnotationFromAnnotation(\n    annotations: Annotations,\n  ): Octokit.ChecksUpdateParamsOutputAnnotations[] {\n    return annotations.map(annotation => {\n      const { level, message, path, column = {}, line = {} } = annotation\n\n      const startLine = line?.start ?? 0\n      const endLine = line?.end ?? 0\n\n      const isSameLinePosition = startLine === endLine\n      const startColumn = isSameLinePosition ? column?.start ?? line.end : undefined\n      const endColumn = isSameLinePosition ? column?.end ?? line.start : undefined\n\n      return {\n        annotation_level: level,\n        message,\n        path,\n        start_column: startColumn,\n        end_column: endColumn,\n        start_line: startLine,\n        end_line: endLine,\n      }\n    })\n  }\n\n  public async createCheck(name: string): Promise<this> {\n    const { owner, repo, sha } = this\n\n    const response = await this.client.checks.create({\n      owner,\n      repo,\n      name,\n      head_sha: sha,\n      status: 'in_progress',\n    })\n\n    this.check = response.data\n\n    return this\n  }\n\n  public async updateCheckWithAnnotations(annotations: Annotations): Promise<void> {\n    if (this.check === null) return\n\n    const { owner, repo } = this\n    const { name, id } = this.check\n\n    await this.client.checks.update({\n      owner,\n      repo,\n      check_run_id: id,\n      name,\n      status: 'completed',\n      conclusion: annotations.conclusion,\n      output: {\n        title: `${name}: output`,\n        summary: `${annotations.length} annotations written`,\n        text: `\n          - Failures: ${annotations.failures.length}\n          - Warnings: ${annotations.warnings.length}\n          - Notices: ${annotations.notices.length}\n        `,\n        annotations: Github.githubAnnotationFromAnnotation(annotations),\n      },\n    })\n  }\n}\n","import core from '@actions/core'\n\nexport interface EnviromentOptions {\n  token: string\n  title: string\n  path: string\n}\n\nexport function getInputs(): EnviromentOptions {\n  const token = core.getInput('token')\n  const path = core.getInput('path')\n  const title = core.getInput('title')\n\n  return validateEnvironmentOptions({ token, path, title })\n}\n\nfunction validateEnvironmentOptions<E extends EnviromentOptions>(\n  environment: Partial<EnviromentOptions>,\n): E {\n  if (!environment.token) {\n    throw new Error('`token` input must be set.')\n  }\n\n  if (!environment.path) {\n    throw new Error('`path` input must be set.')\n  }\n\n  if (!environment.title) {\n    throw new Error('`title` input must be set')\n  }\n\n  return environment as E\n}\n","import { Annotations } from '@/annotations'\nimport { Github } from '@/github'\nimport { getInputs } from '@/inputs'\nimport core from '@actions/core'\nimport fs from 'fs'\n\nasync function main(): Promise<void> {\n  const { token, title, path } = getInputs()\n\n  const github = new Github(token)\n\n  await github.createCheck(title)\n\n  const file = fs.readFileSync(path)\n  const annotations = Annotations.fromJSON(file.toString())\n\n  await github.updateCheckWithAnnotations(annotations)\n}\n\nmain().catch(error => {\n  /* eslint-disable-next-line no-console */\n  console.error(error.stack)\n  core.setFailed(`annotations-action: ${error.message}`)\n})\n"],"names":["Annotations","Array","fromJSON","json","JSON","parse","hasFailure","some","annotation","level","hasWarning","failures","filter","warnings","notices","conclusion","length","Github","constructor","token","client","github","GitHub","auth","context","owner","repo","sha","payload","pull_request","head","githubAnnotationFromAnnotation","annotations","map","message","path","column","line","startLine","start","endLine","end","isSameLinePosition","startColumn","undefined","endColumn","annotation_level","start_column","end_column","start_line","end_line","createCheck","name","response","checks","create","head_sha","status","check","data","updateCheckWithAnnotations","id","update","check_run_id","output","title","summary","text","getInputs","core","getInput","validateEnvironmentOptions","environment","Error","main","file","fs","readFileSync","toString","catch","error","console","stack","setFailed"],"mappings":";;;;;;;;MAIaA,oBAAoBC;AACxB,SAAOC,QAAP,CAAgBC,IAAhB;AACL,WAAO,IAAIH,WAAJ,CAAgB,GAAGI,IAAI,CAACC,KAAL,CAAWF,IAAX,CAAnB,CAAP;AACD;;AAEMG,EAAAA,UAAU;AACf,WAAO,KAAKC,IAAL,CAAUC,UAAU,IAAIA,UAAU,CAACC,KAAX,KAAqB,SAA7C,CAAP;AACD;;AAEMC,EAAAA,UAAU;AACf,WAAO,KAAKH,IAAL,CAAUC,UAAU,IAAIA,UAAU,CAACC,KAAX,KAAqB,SAA7C,CAAP;AACD;;AAED,MAAWE,QAAX;AACE,WAAO,KAAKC,MAAL,CAAYJ,UAAU,IAAIA,UAAU,CAACC,KAAX,KAAqB,SAA/C,CAAP;AACD;;AAED,MAAWI,QAAX;AACE,WAAO,KAAKD,MAAL,CAAYJ,UAAU,IAAIA,UAAU,CAACC,KAAX,KAAqB,SAA/C,CAAP;AACD;;AAED,MAAWK,OAAX;AACE,WAAO,KAAKF,MAAL,CAAYJ,UAAU,IAAIA,UAAU,CAACC,KAAX,KAAqB,QAA/C,CAAP;AACD;;AAED,MAAWM,UAAX;AACE,QAAI,KAAKC,MAAL,KAAgB,CAApB,EAAuB,OAAO,SAAP;AACvB,QAAI,KAAKV,UAAL,EAAJ,EAAuB,OAAO,SAAP;AACvB,QAAI,KAAKI,UAAL,EAAJ,EAAuB,OAAO,SAAP;AACvB,WAAO,SAAP;AACD;;;;MC7BUO;AAQXC,EAAAA,YAAmBC;;;AAFX,cAAA,GAA6C,IAA7C;AAGN,SAAKC,MAAL,GAAc,IAAIC,MAAM,CAACC,MAAX,CAAkB;AAC9BC,MAAAA,IAAI,EAAEJ;AADwB,KAAlB,CAAd;AAGA,SAAKK,OAAL,GAAeH,MAAM,CAACG,OAAtB;AACA,SAAKC,KAAL,GAAa,KAAKD,OAAL,CAAaE,IAAb,CAAkBD,KAA/B;AACA,SAAKC,IAAL,GAAY,KAAKF,OAAL,CAAaE,IAAb,CAAkBA,IAA9B;AACA,SAAKC,GAAL,oCAAW,KAAKH,OAAL,CAAaI,OAAb,CAAqBC,YAAhC,qBAAW,sBAAmCC,IAAnC,CAAwCH,GAAnD,mBAA0D,KAAKH,OAAL,CAAaG,GAAvE;AACD;;AAEO,SAAOI,8BAAP,CACNC,WADM;AAGN,WAAOA,WAAW,CAACC,GAAZ,CAAgBzB,UAAU;;;AAC/B,YAAM;AAAEC,QAAAA,KAAF;AAASyB,QAAAA,OAAT;AAAkBC,QAAAA,IAAlB;AAAwBC,QAAAA,MAAM,GAAG,EAAjC;AAAqCC,QAAAA,IAAI,GAAG;AAA5C,UAAmD7B,UAAzD;AAEA,YAAM8B,SAAS,YAAGD,IAAH,oBAAGA,IAAI,CAAEE,KAAT,oBAAkB,CAAjC;AACA,YAAMC,OAAO,YAAGH,IAAH,oBAAGA,IAAI,CAAEI,GAAT,oBAAgB,CAA7B;AAEA,YAAMC,kBAAkB,GAAGJ,SAAS,KAAKE,OAAzC;AACA,YAAMG,WAAW,GAAGD,kBAAkB,YAAGN,MAAH,oBAAGA,MAAM,CAAEG,KAAX,oBAAoBF,IAAI,CAACI,GAAzB,GAA+BG,SAArE;AACA,YAAMC,SAAS,GAAGH,kBAAkB,YAAGN,MAAH,oBAAGA,MAAM,CAAEK,GAAX,oBAAkBJ,IAAI,CAACE,KAAvB,GAA+BK,SAAnE;AAEA,aAAO;AACLE,QAAAA,gBAAgB,EAAErC,KADb;AAELyB,QAAAA,OAFK;AAGLC,QAAAA,IAHK;AAILY,QAAAA,YAAY,EAAEJ,WAJT;AAKLK,QAAAA,UAAU,EAAEH,SALP;AAMLI,QAAAA,UAAU,EAAEX,SANP;AAOLY,QAAAA,QAAQ,EAAEV;AAPL,OAAP;AASD,KAnBM,CAAP;AAoBD;;AAEM,QAAMW,WAAN,CAAkBC,IAAlB;AACL,UAAM;AAAE3B,MAAAA,KAAF;AAASC,MAAAA,IAAT;AAAeC,MAAAA;AAAf,QAAuB,IAA7B;AAEA,UAAM0B,QAAQ,GAAG,MAAM,KAAKjC,MAAL,CAAYkC,MAAZ,CAAmBC,MAAnB,CAA0B;AAC/C9B,MAAAA,KAD+C;AAE/CC,MAAAA,IAF+C;AAG/C0B,MAAAA,IAH+C;AAI/CI,MAAAA,QAAQ,EAAE7B,GAJqC;AAK/C8B,MAAAA,MAAM,EAAE;AALuC,KAA1B,CAAvB;AAQA,SAAKC,KAAL,GAAaL,QAAQ,CAACM,IAAtB;AAEA,WAAO,IAAP;AACD;;AAEM,QAAMC,0BAAN,CAAiC5B,WAAjC;AACL,QAAI,KAAK0B,KAAL,KAAe,IAAnB,EAAyB;AAEzB,UAAM;AAAEjC,MAAAA,KAAF;AAASC,MAAAA;AAAT,QAAkB,IAAxB;AACA,UAAM;AAAE0B,MAAAA,IAAF;AAAQS,MAAAA;AAAR,QAAe,KAAKH,KAA1B;AAEA,UAAM,KAAKtC,MAAL,CAAYkC,MAAZ,CAAmBQ,MAAnB,CAA0B;AAC9BrC,MAAAA,KAD8B;AAE9BC,MAAAA,IAF8B;AAG9BqC,MAAAA,YAAY,EAAEF,EAHgB;AAI9BT,MAAAA,IAJ8B;AAK9BK,MAAAA,MAAM,EAAE,WALsB;AAM9B1C,MAAAA,UAAU,EAAEiB,WAAW,CAACjB,UANM;AAO9BiD,MAAAA,MAAM,EAAE;AACNC,QAAAA,KAAK,KAAKb,cADJ;AAENc,QAAAA,OAAO,KAAKlC,WAAW,CAAChB,4BAFlB;AAGNmD,QAAAA,IAAI;wBACYnC,WAAW,CAACrB,QAAZ,CAAqBK;wBACrBgB,WAAW,CAACnB,QAAZ,CAAqBG;uBACtBgB,WAAW,CAAClB,OAAZ,CAAoBE;SAN7B;AAQNgB,QAAAA,WAAW,EAAEf,MAAM,CAACc,8BAAP,CAAsCC,WAAtC;AARP;AAPsB,KAA1B,CAAN;AAkBD;;;;SChFaoC;AACd,QAAMjD,KAAK,GAAGkD,IAAI,CAACC,QAAL,CAAc,OAAd,CAAd;AACA,QAAMnC,IAAI,GAAGkC,IAAI,CAACC,QAAL,CAAc,MAAd,CAAb;AACA,QAAML,KAAK,GAAGI,IAAI,CAACC,QAAL,CAAc,OAAd,CAAd;AAEA,SAAOC,0BAA0B,CAAC;AAAEpD,IAAAA,KAAF;AAASgB,IAAAA,IAAT;AAAe8B,IAAAA;AAAf,GAAD,CAAjC;AACD;;AAED,SAASM,0BAAT,CACEC,WADF;AAGE,MAAI,CAACA,WAAW,CAACrD,KAAjB,EAAwB;AACtB,UAAM,IAAIsD,KAAJ,CAAU,4BAAV,CAAN;AACD;;AAED,MAAI,CAACD,WAAW,CAACrC,IAAjB,EAAuB;AACrB,UAAM,IAAIsC,KAAJ,CAAU,2BAAV,CAAN;AACD;;AAED,MAAI,CAACD,WAAW,CAACP,KAAjB,EAAwB;AACtB,UAAM,IAAIQ,KAAJ,CAAU,2BAAV,CAAN;AACD;;AAED,SAAOD,WAAP;AACD;;AC1BD,eAAeE,IAAf;AACE,QAAM;AAAEvD,IAAAA,KAAF;AAAS8C,IAAAA,KAAT;AAAgB9B,IAAAA;AAAhB,MAAyBiC,SAAS,EAAxC;AAEA,QAAM/C,MAAM,GAAG,IAAIJ,MAAJ,CAAWE,KAAX,CAAf;AAEA,QAAME,MAAM,CAAC8B,WAAP,CAAmBc,KAAnB,CAAN;AAEA,QAAMU,IAAI,GAAGC,EAAE,CAACC,YAAH,CAAgB1C,IAAhB,CAAb;AACA,QAAMH,WAAW,GAAGhC,WAAW,CAACE,QAAZ,CAAqByE,IAAI,CAACG,QAAL,EAArB,CAApB;AAEA,QAAMzD,MAAM,CAACuC,0BAAP,CAAkC5B,WAAlC,CAAN;AACD;;AAED0C,IAAI,GAAGK,KAAP,CAAaC,KAAK;AAChB;AACAC,EAAAA,OAAO,CAACD,KAAR,CAAcA,KAAK,CAACE,KAApB;AACAb,EAAAA,IAAI,CAACc,SAAL,wBAAsCH,KAAK,CAAC9C,SAA5C;AACD,CAJD"}